name: GitHub Actions Demo
on: [push]
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      # - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      # - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      # - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      # - name: Check out repository code
      #   uses: actions/checkout@v3
      # - run: echo "💡 The ${{ github.repository }} repository has been cloned to the runner."
      # - run: echo "🖥️ The workflow is now ready to test your code on the runner."
      # - name: List files in the repository
      #   run: |
      #     ls ${{ github.workspace }}
      # - name: Deploy to EC2
      #   uses: easingthemes/ssh-deploy@main
      #   env:
      #     SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
      #     REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
      #     REMOTE_USER: ${{ secrets.REMOTE_USER }}
      #     TARGET: "/home/ubuntu/PotatoSaladBot/"
      #     EXCLUDE: "/dist/, /node_modules/"
      # - run: echo "🍏 This job's status is ${{ job.status }}!"
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/staging.key
          chmod 600 ~/.ssh/staging.key
          cat >>~/.ssh/config <<END
          Host staging
            HostName $SSH_HOST
            User $SSH_USER
            IdentityFile ~/.ssh/staging.key
            StrictHostKeyChecking no
          END
        env:
          SSH_USER: ${{ secrets.REMOTE_USER }}
          SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
          SSH_HOST: ${{ secrets.REMOTE_HOST }}

      #- name: Stop the app if running
      #  run: ssh staging 'sudo systemctl stop my-application'
        
      - name: Add Github SSH key
        run: ssh staging 'echo ${{ secrets.REMOTE_GITHUB_SSH_KEY }} > ~/.ssh/id_ed25519'

      - name: Check out the new code from Github
        run: ssh staging 'git -C PotatoSaladBot pull || git clone git@github.com:SmarakNayak/PotatoSaladBot.git'
        # This pulls if directory exists, otherwise clones

      #- name: Start the app
      #  if: ${{ always() }}
      #  run: ssh staging 'sudo systemctl start my-application'
 
